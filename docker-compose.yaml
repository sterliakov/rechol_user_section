services:
    autoheal:
        restart: always
        image: willfarrell/autoheal
        environment:
        -   AUTOHEAL_CONTAINER_LABEL=all
        volumes:
        -   /var/run/docker.sock:/var/run/docker.sock
    db:
        image: postgres:16-alpine
        env_file:
        -   .env
        restart: always
        volumes:
        -   db_volume_24_25:/var/lib/postgresql/data
        healthcheck:
            test: pg_isready -U ${POSTGRES_USER}
            interval: 10s
            timeout: 5s
            retries: 5

    app:
        env_file: .env
        build:
            context: .
            dockerfile: Dockerfile
            target: deploy
            args:
                UV_FLAGS: --no-dev
        depends_on:
        -   db
        volumes:
        -   media_volume_24_25:/var/www/rechol_user_section/media
        restart: always

    agw:
        image: sterliakov/aws-apigw-emulator
        environment:
            TARGET: app:8080
        depends_on:
        -   app

    nginx:
        build:
            context: .
            dockerfile: Dockerfile
            target: nginx
            args:
            -   NGINX_CONF
        restart: always
        healthcheck:
            test: curl -f http://nginx:80/health
            interval: 10s
            timeout: 5s
            retries: 5
        ports:
        -   80:80
        -   443:443
        depends_on:
        -   app

networks:
    djangonetwork:
        driver: bridge

volumes:
    db_volume_24_25:
    media_volume_24_25:
