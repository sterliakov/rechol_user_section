services:
    db:
        image: cockroachdb/cockroach:latest-v23.2
        command: start-single-node --insecure
        volumes:
        -   db_volume_24_25_cr:/cockroach/cockroach-data
        env_file:
        -   .env
        restart: unless-stopped

    app:
        env_file: .env
        environment:
            ENVIRONMENT: dev
        build:
            context: .
            dockerfile: Dockerfile
            target: deploy
            args:
                UV_FLAGS: --no-dev
        depends_on:
        -   db
        restart: unless-stopped

    agw:
        image: sterliakov/aws-apigw-emulator
        environment:
            TARGET: app:8080
        depends_on:
        -   app

    nginx:
        build:
            context: .
            dockerfile: Dockerfile
            target: nginx
        restart: unless-stopped
        healthcheck:
            test: curl -f http://nginx:80/health
            interval: 10s
            timeout: 5s
            retries: 5
        ports:
        -   80:80
        depends_on:
        -   app

volumes:
    db_volume_24_25_cr:
